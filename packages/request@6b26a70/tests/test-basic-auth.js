function runTest(e){e<tests.length?tests[e](function(){runTest(e+1)}):(console.log("All tests passed"),basicServer.close())}var assert=require("assert"),http=require("http"),request=require("../index"),numBasicRequests=0,basicServer=http.createServer(function(e,t){console.error("Basic auth server: ",e.method,e.url),numBasicRequests++;var n;e.headers.authorization?e.headers.authorization=="Basic "+(new Buffer("test:testing2")).toString("base64")?n=!0:e.headers.authorization=="Basic "+(new Buffer(":apassword")).toString("base64")?n=!0:n=!1:(n=!1,t.setHeader("www-authenticate",'Basic realm="Private"'));if(e.url=="/post/"){var r="data_key=data_value";e.on("data",function(e){assert.equal(e,r),console.log("received request data: "+e)}),assert.equal(e.method,"POST"),assert.equal(e.headers["content-length"],""+r.length),assert.equal(e.headers["content-type"],"application/x-www-form-urlencoded; charset=utf-8")}n?(console.log("request ok"),t.end("ok")):(console.log("status=401"),t.statusCode=401,t.end("401"))});basicServer.listen(6767);var tests=[function(e){request({method:"GET",uri:"http://localhost:6767/test/",auth:{user:"test",pass:"testing2",sendImmediately:!1}},function(t,n,r){assert.equal(n.statusCode,200),assert.equal(numBasicRequests,2),e()})},function(e){request({method:"GET",uri:"http://localhost:6767/test2/",auth:{user:"test",pass:"testing2"}},function(t,n,r){assert.equal(n.statusCode,200),assert.equal(numBasicRequests,3),e()})},function(e){request({method:"GET",uri:"http://test:testing2@localhost:6767/test2/"},function(t,n,r){assert.equal(n.statusCode,200),assert.equal(numBasicRequests,4),e()})},function(e){request({method:"POST",form:{data_key:"data_value"},uri:"http://localhost:6767/post/",auth:{user:"test",pass:"testing2",sendImmediately:!1}},function(t,n,r){assert.equal(n.statusCode,200),assert.equal(numBasicRequests,6),e()})},function(e){assert.doesNotThrow(function(){request({method:"GET",uri:"http://localhost:6767/allow_empty_user/",auth:{user:"",pass:"apassword",sendImmediately:!1}},function(t,n,r){assert.equal(n.statusCode,200),assert.equal(numBasicRequests,8),e()})})}];runTest(0)