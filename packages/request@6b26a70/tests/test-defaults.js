var server=require("./server"),assert=require("assert"),request=require("../index"),s=server.createServer();s.listen(s.port,function(){var e=0;s.on("/get",function(e,t){assert.equal(e.headers.foo,"bar"),assert.equal(e.method,"GET"),t.writeHead(200,{"Content-Type":"text/plain"}),t.end("TESTING!")}),request.defaults({headers:{foo:"bar"}})(s.url+"/get",function(t,n,r){if(t)throw t;assert.deepEqual("TESTING!",r),e+=1}),s.on("/post",function(e,t){assert.equal(e.headers.foo,"bar"),assert.equal(e.headers["content-type"],null),assert.equal(e.method,"POST"),t.writeHead(200,{"Content-Type":"application/json"}),t.end(JSON.stringify({foo:"bar"}))}),request.defaults({headers:{foo:"bar"}}).post(s.url+"/post",{json:!0},function(t,n,r){if(t)throw t;assert.deepEqual("bar",r.foo),e+=1}),s.on("/patch",function(e,t){assert.equal(e.headers.foo,"bar"),assert.equal(e.headers["content-type"],null),assert.equal(e.method,"PATCH"),t.writeHead(200,{"Content-Type":"application/json"}),t.end(JSON.stringify({foo:"bar"}))}),request.defaults({headers:{foo:"bar"}}).patch(s.url+"/patch",{json:!0},function(t,n,r){if(t)throw t;assert.deepEqual("bar",r.foo),e+=1}),s.on("/post-body",function(e,t){assert.equal(e.headers.foo,"bar"),assert.equal(e.headers["content-type"],"application/json"),assert.equal(e.method,"POST"),t.writeHead(200,{"Content-Type":"application/json"}),t.end(JSON.stringify({foo:"bar"}))}),request.defaults({headers:{foo:"bar"}}).post(s.url+"/post-body",{json:!0,body:{bar:"baz"}},function(t,n,r){if(t)throw t;assert.deepEqual("bar",r.foo),e+=1}),s.on("/del",function(e,t){assert.equal(e.headers.foo,"bar"),assert.equal(e.method,"DELETE"),t.writeHead(200,{"Content-Type":"application/json"}),t.end(JSON.stringify({foo:"bar"}))}),request.defaults({headers:{foo:"bar"},json:!0}).del(s.url+"/del",function(t,n,r){if(t)throw t;assert.deepEqual("bar",r.foo),e+=1}),s.on("/head",function(e,t){assert.equal(e.headers.foo,"bar"),assert.equal(e.method,"HEAD"),t.writeHead(200,{"Content-Type":"text/plain"}),t.end()}),request.defaults({headers:{foo:"bar"}}).head({uri:s.url+"/head"},function(t,n,r){if(t)throw t;e+=1}),s.on("/get_custom",function(e,t){assert.equal(e.headers.foo,"bar"),assert.equal(e.headers.x,"y"),t.writeHead(200,{"Content-Type":"text/plain"}),t.end()});var t=request.defaults({headers:{foo:"bar"},body:"TESTING!"},function(e,t,n){var r=request.initParams(e,t,n);return t=r.options,t.headers.x="y",request(r.uri,r.options,r.callback)}),n="defaults test failed. head request should throw earlier";assert.throws(function(){t.head(s.url+"/get_custom",function(e,t,r){throw new Error(n)}),e+=1},n),t.get(s.url+"/get_custom",function(t,n,r){if(t)throw t;e+=1,console.log(e.toString()+" tests passed."),s.close()})})