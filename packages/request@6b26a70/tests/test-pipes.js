function ValidationStream(e){this.str=e,this.buf="",this.on("data",function(e){this.buf+=e}),this.on("end",function(){assert.equal(this.str,this.buf)}),this.writable=!0}var server=require("./server"),events=require("events"),stream=require("stream"),assert=require("assert"),fs=require("fs"),request=require("../index"),path=require("path"),util=require("util"),s=server.createServer(3453);util.inherits(ValidationStream,stream.Stream),ValidationStream.prototype.write=function(e){this.emit("data",e)},ValidationStream.prototype.end=function(e){e&&emit("data",e),this.emit("end")},s.listen(s.port,function(){counter=0;var e=function(){counter-=1,counter===0&&(console.log("All tests passed."),setTimeout(function(){process.exit()},500))};s.once("/push",server.createPostValidator("mydata"));var t=new stream.Stream;t.readable=!0,counter++;var n=request.put({url:"http://localhost:3453/push"},function(){e()});t.pipe(n),t.emit("data","mydata"),t.emit("end"),s.once("/push-json",server.createPostValidator('{"foo":"bar"}',"application/json"));var r=new stream.Stream;r.readable=!0,counter++;var i=request.put({url:"http://localhost:3453/push-json",json:!0},function(){e()});r.pipe(i),r.emit("data",JSON.stringify({foo:"bar"})),r.emit("end"),s.once("/pull",server.createGetResponse("mypulldata"));var o=new stream.Stream;o.writable=!0,counter++,request({url:"http://localhost:3453/pull"}).pipe(o);var u="";o.write=function(e){u+=e},o.end=function(){assert.equal(u,"mypulldata"),e()},s.on("/cat",function(t,n){if(t.method==="GET")n.writeHead(200,{"content-type":"text/plain-test","content-length":4}),n.end("asdf");else if(t.method==="PUT"){assert.equal(t.headers["content-type"],"text/plain-test"),assert.equal(t.headers["content-length"],4);var r="";t.on("data",function(e){r+=e}),t.on("end",function(){n.writeHead(201),n.end(),assert.equal(r,"asdf"),e()})}}),s.on("/pushjs",function(t,n){t.method==="PUT"&&(assert.equal(t.headers["content-type"],"application/javascript"),e())}),s.on("/catresp",function(e,t){request.get("http://localhost:3453/cat").pipe(t)}),s.on("/doodle",function(e,t){e.headers["x-oneline-proxy"]&&t.setHeader("x-oneline-proxy","yup"),t.writeHead("200",{"content-type":"image/jpeg"}),fs.createReadStream(path.join(__dirname,"googledoodle.jpg")).pipe(t)}),s.on("/onelineproxy",function(e,t){var n=request("http://localhost:3453/doodle");e.pipe(n),n.pipe(t)}),counter++,fs.createReadStream(__filename).pipe(request.put("http://localhost:3453/pushjs")),counter++,request.get("http://localhost:3453/cat").pipe(request.put("http://localhost:3453/cat")),counter++,request.get("http://localhost:3453/catresp",function(t,n,r){assert.equal(n.headers["content-type"],"text/plain-test"),assert.equal(n.headers["content-length"],4),e()});var a=fs.createWriteStream(path.join(__dirname,"test.jpg"));counter++,request.get("http://localhost:3453/doodle").pipe(a),a.on("close",function(){assert.deepEqual(fs.readFileSync(path.join(__dirname,"googledoodle.jpg")),fs.readFileSync(path.join(__dirname,"test.jpg"))),e()}),process.on("exit",function(){fs.unlinkSync(path.join(__dirname,"test.jpg"))}),counter++,request.get({uri:"http://localhost:3453/onelineproxy",headers:{"x-oneline-proxy":"nope"}},function(t,n,r){assert.equal(n.headers["x-oneline-proxy"],"yup"),e()}),s.on("/afterresponse",function(e,t){t.write("d"),t.end()}),counter++;var f=request.post("http://localhost:3453/afterresponse").on("response",function(){var t=new ValidationStream("d");f.pipe(t),t.on("end",e)});s.on("/forward1",function(e,t){t.writeHead(302,{location:"/forward2"}),t.end()}),s.on("/forward2",function(e,t){t.writeHead("200",{"content-type":"image/png"}),t.write("d"),t.end()}),counter++;var l=new ValidationStream("d");l.on("end",e),request.get("http://localhost:3453/forward1").pipe(l),s.once("/opts",server.createGetResponse("opts response"));var c=new stream.Stream;c.writable=!0;var h="";c.write=function(t){h+=t,h==="opts response"&&setTimeout(e,10)},c.end=function(){assert.fail("end called")},counter++,request({url:"http://localhost:3453/opts"}).pipe(c,{end:!1})})