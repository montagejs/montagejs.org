function toBase64(e){return(new Buffer(e||"","ascii")).toString("base64")}function md5(e){return crypto.createHash("md5").update(e).digest("hex")}function isReadStream(e){if(e.readable&&e.path&&e.mode)return!0}function copy(e){var t={};return Object.keys(e).forEach(function(n){t[n]=e[n]}),t}function Request(e){stream.Stream.call(this),this.readable=!0,this.writable=!0,typeof e=="string"&&(e={uri:e});var t=Object.keys(Request.prototype);for(var n in e)t.indexOf(n)===-1?this[n]=e[n]:typeof e[n]=="function"&&delete e[n];e.method&&(this.explicitMethod=!0),this.init(e)}function getHeader(e,t){var n,r,i;return Object.keys(t).forEach(function(s){r=new RegExp(e,"i"),i=s.match(r),i&&(n=t[s])}),n}function initParams(e,t,n){return typeof t=="function"&&!n&&(n=t),t&&typeof t=="object"?t.uri=e:typeof e=="string"?t={uri:e}:(t=e,e=t.uri),{uri:e,options:t,callback:n}}function request(e,t,n){if(typeof e=="undefined")throw new Error("undefined is not a valid uri or options object.");typeof t=="function"&&!n&&(n=t),t&&typeof t=="object"?t.uri=e:typeof e=="string"?t={uri:e}:t=e,t=copy(t),n&&(t.callback=n);var r=new Request(t);return r}function getSafe(e,t){if(typeof e=="object"||typeof e=="function")var n={};if(Array.isArray(e))var n=[];var r=[];Object.defineProperty(e,t,{});var i=Object.keys(e).filter(function(n){return n===t?!1:typeof e[n]!="object"&&typeof e[n]!="function"||e[n]===null?!0:!Object.getOwnPropertyDescriptor(e[n],t)});for(var s=0;s<i.length;s++)typeof e[i[s]]!="object"&&typeof e[i[s]]!="function"||e[i[s]]===null?n[i[s]]=e[i[s]]:(r.push(i[s]),Object.defineProperty(e[i[s]],t,{}));for(var s=0;s<r.length;s++)n[r[s]]=getSafe(e[r[s]],t);return n}function toJSON(){return getSafe(this,"__"+((1+Math.random())*65536|0).toString(16))}var http=require("http"),https=!1,tls=!1,url=require("url"),util=require("util"),stream=require("stream"),qs=require("qs"),querystring=require("querystring"),crypto=require("crypto"),oauth=require("oauth-sign"),hawk=require("hawk"),aws=require("aws-sign"),httpSignature=require("http-signature"),uuid=require("node-uuid"),mime=require("mime"),tunnel=require("tunnel-agent"),safeStringify=require("json-stringify-safe"),ForeverAgent=require("forever-agent"),FormData=require("form-data"),Cookie=require("cookie-jar"),CookieJar=Cookie.Jar,cookieJar=new CookieJar;try{https=require("https")}catch(e){}try{tls=require("tls")}catch(e){}var debug;/\brequest\b/.test(process.env.NODE_DEBUG)?debug=function(){console.error("REQUEST %s",util.format.apply(util,arguments))}:debug=function(){},https&&!https.Agent&&(https.Agent=function(e){http.Agent.call(this,e)},util.inherits(https.Agent,http.Agent),https.Agent.prototype._getConnection=function(e,t,n){var r=tls.connect(t,e,this.options,function(){n&&n()});return r});var isUrl=/^https?:/,globalPool={};util.inherits(Request,stream.Stream),Request.prototype.init=function(e){var t=this;e||(e={}),t.method||(t.method=e.method||"GET"),t.localAddress=e.localAddress,debug(e),!t.pool&&t.pool!==!1&&(t.pool=globalPool),t.dests=t.dests||[],t.__isRequestRequest=!0,!t._callback&&t.callback&&(t._callback=t.callback,t.callback=function(){if(t._callbackCalled)return;t._callbackCalled=!0,t._callback.apply(t,arguments)},t.on("error",t.callback.bind()),t.on("complete",t.callback.bind(t,null))),t.url&&(t.uri=t.url,delete t.url);if(!t.uri)return t.emit("error",new Error("options.uri is a required argument"));typeof t.uri=="string"&&(t.uri=url.parse(t.uri)),t.strictSSL===!1&&(t.rejectUnauthorized=!1);if(t.proxy){typeof t.proxy=="string"&&(t.proxy=url.parse(t.proxy));if(http.globalAgent&&t.uri.protocol==="https:"){var n=t.proxy.protocol==="http:"?tunnel.httpsOverHttp:tunnel.httpsOverHttps,r={proxy:{host:t.proxy.hostname,port:+t.proxy.port,proxyAuth:t.proxy.auth,headers:{Host:t.uri.hostname+":"+(t.uri.port||t.uri.protocol==="https:"?443:80)}},rejectUnauthorized:t.rejectUnauthorized,ca:this.ca};t.agent=n(r),t.tunnel=!0}}if(!t.uri.host||!t.uri.pathname){var i=url.format(t.uri),s='Invalid URI "'+i+'"';Object.keys(e).length===0&&(s+=". This can be caused by a crappy redirection."),t.emit("error",new Error(s));return}t._redirectsFollowed=t._redirectsFollowed||0,t.maxRedirects=t.maxRedirects!==undefined?t.maxRedirects:10,t.followRedirect=t.followRedirect!==undefined?t.followRedirect:!0,t.followAllRedirects=t.followAllRedirects!==undefined?t.followAllRedirects:!1;if(t.followRedirect||t.followAllRedirects)t.redirects=t.redirects||[];t.headers=t.headers?copy(t.headers):{},t.setHost=!1,!t.headers.host&&!t.headers.Host&&(t.headers.host=t.uri.hostname,t.uri.port&&(t.uri.port!==80||t.uri.protocol!=="http:")&&(t.uri.port!==443||t.uri.protocol!=="https:")&&(t.headers.host+=":"+t.uri.port),t.setHost=!0),t.jar(t._jar||e.jar),t.uri.pathname||(t.uri.pathname="/"),t.uri.port||(t.uri.protocol=="http:"?t.uri.port=80:t.uri.protocol=="https:"&&(t.uri.port=443)),t.proxy&&!t.tunnel?(t.port=t.proxy.port,t.host=t.proxy.hostname):(t.port=t.uri.port,t.host=t.uri.hostname),t.clientErrorHandler=function(e){if(t._aborted)return;if(t.req&&t.req._reusedSocket&&e.code==="ECONNRESET"&&t.agent.addRequestNoreuse){t.agent={addRequest:t.agent.addRequestNoreuse.bind(t.agent)},t.start(),t.req.end();return}t.timeout&&t.timeoutTimer&&(clearTimeout(t.timeoutTimer),t.timeoutTimer=null),t.emit("error",e)},t._parserErrorHandler=function(e){this.res?this.res.request?this.res.request.emit("error",e):this.res.emit("error",e):this._httpMessage.emit("error",e)},e.form&&t.form(e.form),e.qs&&t.qs(e.qs),t.uri.path?t.path=t.uri.path:t.path=t.uri.pathname+(t.uri.search||""),t.path.length===0&&(t.path="/"),e.oauth&&t.oauth(e.oauth),e.aws&&t.aws(e.aws),e.hawk&&t.hawk(e.hawk),e.httpSignature&&t.httpSignature(e.httpSignature),e.auth&&t.auth(e.auth.user===""?e.auth.user:e.auth.user||e.auth.username,e.auth.pass||e.auth.password,e.auth.sendImmediately);if(t.uri.auth&&!t.headers.authorization){var o=t.uri.auth.split(":").map(function(e){return querystring.unescape(e)});t.auth(o[0],o.slice(1).join(":"),!0)}t.proxy&&t.proxy.auth&&!t.headers["proxy-authorization"]&&!t.tunnel&&(t.headers["proxy-authorization"]="Basic "+toBase64(t.proxy.auth.split(":").map(function(e){return querystring.unescape(e)}).join(":"))),t.proxy&&!t.tunnel&&(t.path=t.uri.protocol+"//"+t.uri.host+t.path),e.json?t.json(e.json):e.multipart&&(t.boundary=uuid(),t.multipart(e.multipart));if(t.body){var u=0;if(!Buffer.isBuffer(t.body))if(Array.isArray(t.body))for(var a=0;a<t.body.length;a++)u+=t.body[a].length;else t.body=new Buffer(t.body),u=t.body.length;else u=t.body.length;if(!u)throw new Error("Argument error, options.body.");!t.headers["content-length"]&&!t.headers["Content-Length"]&&(t.headers["content-length"]=u)}var f=t.proxy&&!t.tunnel?t.proxy.protocol:t.uri.protocol,l={"http:":http,"https:":https},c=t.httpModules||{};t.httpModule=c[f]||l[f];if(!t.httpModule)return this.emit("error",new Error("Invalid protocol"));e.ca&&(t.ca=e.ca),t.agent||(e.agentOptions&&(t.agentOptions=e.agentOptions),e.agentClass?t.agentClass=e.agentClass:e.forever?t.agentClass=f==="http:"?ForeverAgent:ForeverAgent.SSL:t.agentClass=t.httpModule.Agent),t.pool===!1?t.agent=!1:(t.agent=t.agent||t.getAgent(),t.maxSockets&&(t.agent.maxSockets=t.maxSockets),t.pool.maxSockets&&(t.agent.maxSockets=t.pool.maxSockets)),t.once("pipe",function(e){if(t.ntick&&t._started)throw new Error("You cannot pipe to this stream after the outbound request has started.");t.src=e;if(isReadStream(e))!t.headers["content-type"]&&!t.headers["Content-Type"]&&(t.headers["content-type"]=mime.lookup(e.path));else{if(e.headers)for(var n in e.headers)t.headers[n]||(t.headers[n]=e.headers[n]);t._json&&!t.headers["content-type"]&&!t.headers["Content-Type"]&&(t.headers["content-type"]="application/json"),e.method&&!t.explicitMethod&&(t.method=e.method)}t.on("pipe",function(){console.error("You have already piped to this stream. Pipeing twice is likely to break the request.")})}),process.nextTick(function(){if(t._aborted)return;t._form&&(t.setHeaders(t._form.getHeaders()),t._form.pipe(t)),t.body?(Array.isArray(t.body)?t.body.forEach(function(e){t.write(e)}):t.write(t.body),t.end()):t.requestBodyStream?(console.warn("options.requestBodyStream is deprecated, please pass the request object to stream.pipe."),t.requestBodyStream.pipe(t)):t.src||(t.method!=="GET"&&typeof t.method!="undefined"&&(t.headers["content-length"]=0),t.end()),t.ntick=!0})},Request.prototype._updateProtocol=function(){var e=this,t=e.uri.protocol;if(t==="https:"){if(e.proxy){e.tunnel=!0;var n=e.proxy.protocol==="http:"?tunnel.httpsOverHttp:tunnel.httpsOverHttps,r={proxy:{host:e.proxy.hostname,port:+e.proxy.port,proxyAuth:e.proxy.auth},rejectUnauthorized:e.rejectUnauthorized,ca:e.ca};e.agent=n(r);return}e.httpModule=https;switch(e.agentClass){case ForeverAgent:e.agentClass=ForeverAgent.SSL;break;case http.Agent:e.agentClass=https.Agent;break;default:return}e.agent&&(e.agent=e.getAgent())}else{e.tunnel&&(e.tunnel=!1),e.httpModule=http;switch(e.agentClass){case ForeverAgent.SSL:e.agentClass=ForeverAgent;break;case https.Agent:e.agentClass=http.Agent;break;default:return}e.agent&&(e.agent=null,e.agent=e.getAgent())}},Request.prototype.getAgent=function(){var e=this.agentClass,t={};if(this.agentOptions)for(var n in this.agentOptions)t[n]=this.agentOptions[n];this.ca&&(t.ca=this.ca),typeof this.rejectUnauthorized!="undefined"&&(t.rejectUnauthorized=this.rejectUnauthorized),this.cert&&this.key&&(t.key=this.key,t.cert=this.cert);var r="";e!==this.httpModule.Agent&&(r+=e.name),this.httpModule.globalAgent||(t.host=this.host,t.port=this.port,r&&(r+=":"),r+=this.host+":"+this.port);var i=this.proxy;typeof i=="string"&&(i=url.parse(i));var s=i&&i.protocol==="https:"||this.uri.protocol==="https:";return s&&(t.ca&&(r&&(r+=":"),r+=t.ca),typeof t.rejectUnauthorized!="undefined"&&(r&&(r+=":"),r+=t.rejectUnauthorized),t.cert&&(r+=t.cert.toString("ascii")+t.key.toString("ascii"))),!r&&e===this.httpModule.Agent&&this.httpModule.globalAgent?this.httpModule.globalAgent:(r=this.uri.protocol+r,this.pool[r]?this.pool[r]:this.pool[r]=new e(t))},Request.prototype.start=function(){var e=this;if(e._aborted)return;e._started=!0,e.method=e.method||"GET",e.href=e.uri.href,e.src&&e.src.stat&&e.src.stat.size&&!e.headers["content-length"]&&!e.headers["Content-Length"]&&(e.headers["content-length"]=e.src.stat.size),e._aws&&e.aws(e._aws,!0);var t=copy(e);delete t.auth,debug("make request",e.uri.href),e.req=e.httpModule.request(t,e.onResponse.bind(e)),e.timeout&&!e.timeoutTimer&&(e.timeoutTimer=setTimeout(function(){e.req.abort();var t=new Error("ETIMEDOUT");t.code="ETIMEDOUT",e.emit("error",t)},e.timeout),e.req.setTimeout&&e.req.setTimeout(e.timeout,function(){if(e.req){e.req.abort();var t=new Error("ESOCKETTIMEDOUT");t.code="ESOCKETTIMEDOUT",e.emit("error",t)}})),e.req.on("error",e.clientErrorHandler),e.req.on("drain",function(){e.emit("drain")}),e.on("end",function(){e.req.connection&&e.req.connection.removeListener("error",e._parserErrorHandler)}),e.emit("request",e.req)},Request.prototype.onResponse=function(e){var t=this;debug("onResponse",t.uri.href,e.statusCode,e.headers),e.on("end",function(){debug("response end",t.uri.href,e.statusCode,e.headers)}),e.connection.listeners("error").indexOf(t._parserErrorHandler)===-1&&e.connection.once("error",t._parserErrorHandler);if(t._aborted){debug("aborted",t.uri.href),e.resume();return}t._paused?e.pause():e.resume(),t.response=e,e.request=t,e.toJSON=toJSON;if(t.httpModule===https&&t.strictSSL&&!e.client.authorized){debug("strict ssl error",t.uri.href);var n=e.client.authorizationError;t.emit("error",new Error("SSL Error: "+n));return}t.setHost&&delete t.headers.host,t.timeout&&t.timeoutTimer&&(clearTimeout(t.timeoutTimer),t.timeoutTimer=null);var r=function(e){t._jar?t._jar.add(new Cookie(e)):cookieJar.add(new Cookie(e))};e.headers["set-cookie"]&&!t._disableCookies&&(Array.isArray(e.headers["set-cookie"])?e.headers["set-cookie"].forEach(r):r(e.headers["set-cookie"]));var i=null;if(e.statusCode>=300&&e.statusCode<400&&e.headers.location){debug("redirect",e.headers.location);if(t.followAllRedirects)i=e.headers.location;else if(t.followRedirect)switch(t.method){case"PATCH":case"PUT":case"POST":case"DELETE":break;default:i=e.headers.location}}else if(e.statusCode==401&&t._hasAuth&&!t._sentAuth){var s=e.headers["www-authenticate"],o=s&&s.split(" ")[0];debug("reauth",o);switch(o){case"Basic":t.auth(t._user,t._pass,!0),i=t.uri;break;case"Digest":var u=s.match(/([a-z0-9_-]+)="([^"]+)"/gi),a={};for(var f=0;f<u.length;f++){var l=u[f].indexOf("="),c=u[f].substring(0,l),h=u[f].substring(l+1);a[c]=h.substring(1,h.length-1)}var p=md5(t._user+":"+a.realm+":"+t._pass),d=md5(t.method+":"+t.uri.path),v=md5(p+":"+a.nonce+":1::auth:"+d),m={username:t._user,realm:a.realm,nonce:a.nonce,uri:t.uri.path,qop:a.qop,response:v,nc:1,cnonce:""};s=[];for(var g in m)s.push(g+'="'+m[g]+'"');s="Digest "+s.join(", "),t.setHeader("authorization",s),t._sentAuth=!0,i=t.uri}}if(i){debug("redirect to",i),t._paused&&e.resume();if(t._redirectsFollowed>=t.maxRedirects){t.emit("error",new Error("Exceeded maxRedirects. Probably stuck in a redirect loop "+t.uri.href));return}t._redirectsFollowed+=1,isUrl.test(i)||(i=url.resolve(t.uri.href,i));var y=t.uri;t.uri=url.parse(i),t.uri.protocol!==y.protocol&&t._updateProtocol(),t.redirects.push({statusCode:e.statusCode,redirectUri:i}),t.followAllRedirects&&e.statusCode!=401&&(t.method="GET"),delete t.src,delete t.req,delete t.agent,delete t._started,e.statusCode!=401&&(delete t.body,delete t._form,t.headers&&(delete t.headers.host,delete t.headers["content-type"],delete t.headers["content-length"])),t.emit("redirect"),t.init();return}t._redirectsFollowed=t._redirectsFollowed||0,e.on("close",function(){t._ended||t.response.emit("end")}),t.encoding&&(t.dests.length!==0?console.error("Ingoring encoding parameter as this stream is being piped to another stream which makes the encoding option invalid."):e.setEncoding(t.encoding)),t.emit("response",e),t.dests.forEach(function(e){t.pipeDest(e)}),e.on("data",function(e){t._destdata=!0,t.emit("data",e)}),e.on("end",function(e){t._ended=!0,t.emit("end",e)}),e.on("close",function(){t.emit("close")});if(t.callback){var b=[],w=0;t.on("data",function(e){b.push(e),w+=e.length}),t.on("end",function(){debug("end event",t.uri.href);if(t._aborted){debug("aborted",t.uri.href);return}if(b.length&&Buffer.isBuffer(b[0])){debug("has body",t.uri.href,w);var n=new Buffer(w),r=0;b.forEach(function(e){e.copy(n,r,0,e.length),r+=e.length}),t.encoding===null?e.body=n:e.body=n.toString(t.encoding)}else b.length&&(t.encoding==="utf8"&&b[0].length>0&&b[0][0]==="ï»¿"&&(b[0]=b[0].substring(1)),e.body=b.join(""));if(t._json)try{e.body=JSON.parse(e.body)}catch(i){}debug("emitting complete",t.uri.href),e.body==undefined&&!t._json&&(e.body=""),t.emit("complete",e,e.body)})}debug("finish init function",t.uri.href)},Request.prototype.abort=function(){this._aborted=!0,this.req?this.req.abort():this.response&&this.response.abort(),this.emit("abort")},Request.prototype.pipeDest=function(e){var t=this.response;e.headers&&(e.headers["content-type"]=t.headers["content-type"],t.headers["content-length"]&&(e.headers["content-length"]=t.headers["content-length"]));if(e.setHeader){for(var n in t.headers)e.setHeader(n,t.headers[n]);e.statusCode=t.statusCode}this.pipefilter&&this.pipefilter(t,e)},Request.prototype.setHeader=function(e,t,n){return n===undefined&&(n=!0),n||!this.headers.hasOwnProperty(e)?this.headers[e]=t:this.headers[e]+=","+t,this},Request.prototype.setHeaders=function(e){for(var t in e)this.setHeader(t,e[t]);return this},Request.prototype.qs=function(e,t){var n;!t&&this.uri.query?n=qs.parse(this.uri.query):n={};for(var r in e)n[r]=e[r];return qs.stringify(n)===""?this:(this.uri=url.parse(this.uri.href.split("?")[0]+"?"+qs.stringify(n)),this.url=this.uri,this.path=this.uri.path,this)},Request.prototype.form=function(e){return e?(this.headers["content-type"]="application/x-www-form-urlencoded; charset=utf-8",this.body=qs.stringify(e).toString("utf8"),this):(this._form=new FormData,this._form)},Request.prototype.multipart=function(e){var t=this;t.body=[],t.headers["content-type"]?t.headers["content-type"]=t.headers["content-type"].split(";")[0]+"; boundary="+t.boundary:t.headers["content-type"]="multipart/related; boundary="+t.boundary;if(!e.forEach)throw new Error("Argument error, options.multipart.");return t.preambleCRLF&&t.body.push(new Buffer("\r\n")),e.forEach(function(e){var n=e.body;if(n==null)throw Error("Body attribute missing in multipart.");delete e.body;var r="--"+t.boundary+"\r\n";Object.keys(e).forEach(function(t){r+=t+": "+e[t]+"\r\n"}),r+="\r\n",t.body.push(new Buffer(r)),t.body.push(new Buffer(n)),t.body.push(new Buffer("\r\n"))}),t.body.push(new Buffer("--"+t.boundary+"--")),t},Request.prototype.json=function(e){var t=this,n=function(){!t.headers.accept&&!t.headers.Accept&&t.setHeader("accept","application/json")};return n(),this._json=!0,typeof e=="boolean"?typeof this.body=="object"&&(n(),this.body=safeStringify(this.body),t.setHeader("content-type","application/json")):(n(),this.body=safeStringify(e),t.setHeader("content-type","application/json")),this},Request.prototype.auth=function(e,t,n){if(typeof e!="string"||t!==undefined&&typeof t!="string")throw new Error("auth() received invalid user or password");this._user=e,this._pass=t,this._hasAuth=!0;if(n||typeof n=="undefined")this.setHeader("authorization","Basic "+toBase64(e+":"+t)),this._sentAuth=!0;return this},Request.prototype.aws=function(e,t){if(!t)return this._aws=e,this;var n=new Date;this.setHeader("date",n.toUTCString());var r={key:e.key,secret:e.secret,verb:this.method.toUpperCase(),date:n,contentType:getHeader("content-type",this.headers)||"",md5:getHeader("content-md5",this.headers)||"",amazonHeaders:aws.canonicalizeHeaders(this.headers)};return e.bucket&&this.path?r.resource="/"+e.bucket+this.path:e.bucket&&!this.path?r.resource="/"+e.bucket:!e.bucket&&this.path?r.resource=this.path:!e.bucket&&!this.path&&(r.resource="/"),r.resource=aws.canonicalizeResource(r.resource),this.setHeader("authorization",aws.authorization(r)),this},Request.prototype.httpSignature=function(e){var t=this;return httpSignature.signRequest({getHeader:function(e){return getHeader(e,t.headers)},setHeader:function(e,n){t.setHeader(e,n)},method:this.method,path:this.path},e),debug("httpSignature authorization",getHeader("authorization",this.headers)),this},Request.prototype.hawk=function(e){this.headers.Authorization=hawk.client.header(this.uri,this.method,e).field},Request.prototype.oauth=function(e){var t;this.headers["content-type"]&&this.headers["content-type"].slice(0,"application/x-www-form-urlencoded".length)==="application/x-www-form-urlencoded"&&(t=qs.parse(this.body)),this.uri.query&&(t=qs.parse(this.uri.query)),t||(t={});var n={};for(var r in t)n[r]=t[r];for(var r in e)n["oauth_"+r]=e[r];n.oauth_version||(n.oauth_version="1.0"),n.oauth_timestamp||(n.oauth_timestamp=Math.floor(Date.now()/1e3).toString()),n.oauth_nonce||(n.oauth_nonce=uuid().replace(/-/g,"")),n.oauth_signature_method="HMAC-SHA1";var i=n.oauth_consumer_secret;delete n.oauth_consumer_secret;var s=n.oauth_token_secret;delete n.oauth_token_secret;var o=n.oauth_timestamp,u=this.uri.protocol+"//"+this.uri.host+this.uri.pathname,a=oauth.hmacsign(this.method,u,n,i,s);for(var r in t)r.slice(0,"oauth_")in e||(delete n["oauth_"+r],r!=="x_auth_mode"&&delete n[r]);return n.oauth_timestamp=o,this.headers.Authorization="OAuth "+Object.keys(n).sort().map(function(e){return e+'="'+oauth.rfc3986(n[e])+'"'}).join(","),this.headers.Authorization+=',oauth_signature="'+oauth.rfc3986(a)+'"',this},Request.prototype.jar=function(e){var t;this._redirectsFollowed===0&&(this.originalCookieHeader=this.headers.cookie),e===!1?(t=!1,this._disableCookies=!0):e?t=e.get({url:this.uri.href}):t=cookieJar.get({url:this.uri.href});if(t&&t.length){var n=t.map(function(e){return e.name+"="+e.value}).join("; ");this.originalCookieHeader?this.headers.cookie=this.originalCookieHeader+"; "+n:this.headers.cookie=n}return this._jar=e,this},Request.prototype.pipe=function(e,t){if(this.response){if(this._destdata)throw new Error("You cannot pipe after data has been emitted from the response.");if(this._ended)throw new Error("You cannot pipe after the response has been ended.");return stream.Stream.prototype.pipe.call(this,e,t),this.pipeDest(e),e}return this.dests.push(e),stream.Stream.prototype.pipe.call(this,e,t),e},Request.prototype.write=function(){return this._started||this.start(),this.req.write.apply(this.req,arguments)},Request.prototype.end=function(e){e&&this.write(e),this._started||this.start(),this.req.end()},Request.prototype.pause=function(){this.response?this.response.pause.apply(this.response,arguments):this._paused=!0},Request.prototype.resume=function(){this.response?this.response.resume.apply(this.response,arguments):this._paused=!1},Request.prototype.destroy=function(){this._ended?this.response&&this.response.destroy():this.end()},module.exports=request,request.debug=process.env.NODE_DEBUG&&/request/.test(process.env.NODE_DEBUG),request.initParams=initParams,request.defaults=function(e,t){var n=function(n){var r=function(r,i,s){var o=initParams(r,i,s);for(var u in e)o.options[u]===undefined&&(o.options[u]=e[u]);return typeof t=="function"&&(n===request?n=t:o.options._requester=t),n(o.options,o.callback)};return r},r=n(request);return r.get=n(request.get),r.patch=n(request.patch),r.post=n(request.post),r.put=n(request.put),r.head=n(request.head),r.del=n(request.del),r.cookie=n(request.cookie),r.jar=request.jar,r},request.forever=function(e,t){var n={};if(t)for(option in t)n[option]=t[option];return e&&(n.agentOptions=e),n.forever=!0,request.defaults(n)},request.get=request,request.post=function(e,t,n){var r=initParams(e,t,n);return r.options.method="POST",request(r.uri||null,r.options,r.callback)},request.put=function(e,t,n){var r=initParams(e,t,n);return r.options.method="PUT",request(r.uri||null,r.options,r.callback)},request.patch=function(e,t,n){var r=initParams(e,t,n);return r.options.method="PATCH",request(r.uri||null,r.options,r.callback)},request.head=function(e,t,n){var r=initParams(e,t,n);r.options.method="HEAD";if(r.options.body||r.options.requestBodyStream||r.options.json&&typeof r.options.json!="boolean"||r.options.multipart)throw new Error("HTTP HEAD requests MUST NOT include a request body.");return request(r.uri||null,r.options,r.callback)},request.del=function(e,t,n){var r=initParams(e,t,n);return r.options.method="DELETE",typeof r.options._requester=="function"&&(request=r.options._requester),request(r.uri||null,r.options,r.callback)},request.jar=function(){return new CookieJar},request.cookie=function(e){e&&e.uri&&(e=e.uri);if(typeof e!="string")throw new Error("The cookie function only accepts STRING as param");return new Cookie(e)},Request.prototype.toJSON=toJSON