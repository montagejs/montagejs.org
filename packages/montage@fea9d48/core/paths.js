var Montage=require("core/core").Montage,WeakMap=require("collections/weak-map"),Map=require("collections/map"),parse=require("frb/parse"),evaluate=require("frb/evaluate"),assign=require("frb/assign"),observe=require("frb/observe"),bind=require("frb/bind"),compileObserver=require("frb/compile-observer"),Scope=require("frb/scope"),Observers=require("frb/observers"),autoCancelPrevious=Observers.autoCancelPrevious,pathChangeDescriptors=new WeakMap,pathPropertyDescriptors={getPath:{value:function(e,t,n,r){return evaluate(e,this,t||this,n,r)}},setPath:{value:function(e,t,n,r,i){return assign(this,e,t,n||this,r,i)}},observePath:{value:function(e,t){var n=parse(e),r=compileObserver(n);return r(autoCancelPrevious(t),new Scope(this))}},addRangeAtPathChangeListener:{value:function(e,t,n){function r(e,r,i){if(t[n])t[n](e,r,i);else{if(!t.call)throw Error("Can't dispatch range change to "+t);t.call(null,e,r,i)}}n=n||"handleRangeChange";var i=[];return this.addPathChangeListener(e,function(e){return e=e||[],r(e.slice(),i.slice(),0),i=e,e.addRangeChangeListener(r)})}},getPathChangeDescriptors:{value:function(){return pathChangeDescriptors.has(this)||pathChangeDescriptors.set(this,{}),pathChangeDescriptors.get(this)}},getPathChangeDescriptor:{value:function(e,t,n){var r=Montage.getPathChangeDescriptors.call(this);return Object.owns(r,e)||(r[e]={willChangeListeners:new Map,changeListeners:new Map}),r=r[e],r=n?r.willChangeListeners:r.changeListeners,r.has(t)||r.set(t,{path:e,handler:t,beforeChange:n,cancel:Function.noop}),r.get(t)}},addPathChangeListener:{value:function(e,t,n,r){var i=this;t=t||Function.noop;var a=Montage.getPathChangeDescriptor.call(this,e,t,r);a.cancel();var o,s,u,l=parse(e);if(t===Function.noop)u=function(t){if(s)throw Error("Path change handler needs a handler because it emits new values when the source changes: "+JSON.stringify(e));s=!0,o=t};else if(n)u=function(r){return t[n].call(t,r,e,i)};else if(t.handlePathChange)u=function(n){return t.handlePathChange.call(t,n,e,i)};else{if("function"!=typeof t)throw Error("Can't recognize handler type: "+t+". Must be function or delegate implementing handlePathChange.");u=function(n){return t.call(i,n,e,i)}}var c=compileObserver(l),d=c(autoCancelPrevious(u),new Scope(this));return a.cancel=d,s?o:d}},removePathChangeListener:{value:function(e,t,n){t=t||Function.noop;var r=Montage.getPathChangeDescriptors.call(this),i=n?"willChangeListeners":"changeListeners";if(!Object.owns(r,e))throw Error("Can't find "+i+" for "+JSON.stringify(e));var a=r[e],o=a[i];if(!o.has(t))throw Error("Can't find "+i+" for "+JSON.stringify(e));var s=o.get(t);s.cancel(),o["delete"](t),0===a.willChangeListeners.length&&0===a.changeListeners.length&&delete r[e];for(var u in r)return;pathChangeDescriptors["delete"](this)}},addBeforePathChangeListener:{value:function(e,t,n){return Montage.addPathChangeListener.call(this,e,t,n,!0)}},removeBeforePathChangeListener:{value:function(e,t){return Montage.removePathChangeListener.call(this,e,t,!0)}}};Montage.defineProperties(Montage,pathPropertyDescriptors),Montage.defineProperties(Montage.prototype,pathPropertyDescriptors);