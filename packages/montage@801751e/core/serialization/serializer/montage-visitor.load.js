montageDefine("801751e","core/serialization/serializer/montage-visitor",{dependencies:["montage","./montage-serializer","./properties-serializer","./self-serializer","./unit-serializer","mousse/serialization/visitor"],factory:function(e,n){var s=e("montage").Montage,a=e("./montage-serializer"),t=e("./properties-serializer").PropertiesSerializer,o=e("./self-serializer").SelfSerializer,i=e("./unit-serializer").UnitSerializer,r=e("mousse/serialization/visitor").Visitor,l=s.specialize.call(r,{_MONTAGE_ID_ATTRIBUTE:{value:"data-montage-id"},_require:{value:null},_units:{value:null},_elements:{value:null},constructor:{value:function l(){}},initWithBuilderAndLabelerAndRequireAndUnits:{value:function(e,n,s,a){return r.call(this,e,n),this._require=s,this._units=a,this._elements=[],this}},getTypeOf:{value:function(e){return"getInfoForObject"in e||"getInfoForObject"in e.constructor?"MontageObject":e.thisIsAReferenceCreatedByMontageSerializer?"MontageReference":"undefined"!=typeof Element&&Element.isElement(e)?"Element":void 0}},visitMontageReference:{value:function(e,n,s){this.builder.top.setProperty(s,n.reference)}},visitElement:{value:function(e,n,s){var a,t;if(t=n.getAttribute(this._MONTAGE_ID_ATTRIBUTE),!t)throw Error("Not possible to serialize a DOM element with no "+this._MONTAGE_ID_ATTRIBUTE+" assigned: "+n.outerHTML);a=this.builder.createElementReference(t),this.storeValue(a,n,s),this._elements.push(n)}},visitMontageObject:{value:function(e,n,s){this.isObjectSerialized(n)?this.serializeReferenceToMontageObject(e,n,s):this.handleMontageObject(e,n,s)}},handleMontageObject:{value:function(e,n,s){var a,t=this.builder.createCustomObject();this.setObjectSerialization(n,t),a=this.serializeMontageObject(e,n,t),a?this.serializeSubstituteObject(e,n,s,t,a):(t.setLabel(this.labeler.getObjectLabel(n)),this.builder.top.setProperty(s,t))}},serializeReferenceToMontageObject:{value:function(e,n,s){var a=this.labeler.getObjectLabel(n),t=this.builder.createObjectReference(a);this.builder.top.setProperty(s,t)}},serializeSubstituteObject:{value:function(e,n,s,a,t){var o,i,r,l;o=this.labeler.getObjectLabel(n),this.labeler.isUserDefinedLabel(o)?(i=this.labeler.getObjectLabel(t),this.labeler.setObjectLabel(t,o),this.builder.relabelReferences(i,o),l=this.getObjectSerialization(t),l&&(l.setLabel(o),this.labeler.isUserDefinedLabel(i)&&this.builder.createObjectReference(o).setLabel(i)),e.visit(t,s)):(e.visit(t,s),r=this.labeler.getObjectLabel(t),this.labeler.setObjectLabel(n,r),this.builder.relabelReferences(o,r))}},serializeMontageObject:{value:function(e,n,s){var a,t,i=this.builder.createObjectLiteral();return this.setObjectType(n,s),s.setProperty("properties",i),this.builder.push(s),"function"==typeof n.serializeSelf?(a=(new o).initWithMalkerAndVisitorAndObject(e,this,n,s),t=n.serializeSelf(a)):(this.setObjectProperties(e,n),this.setObjectCustomUnits(e,n)),this.builder.pop(),0===i.getPropertyNames().length&&s.clearProperty("properties"),t}},setObjectType:{value:function(e,n){var a=s.getInfoForObject(e).isInstance,t=this.getObjectLocationId(e),o=this.builder.createString(t);a?n.setProperty("prototype",o):n.setProperty("object",o)}},getObjectModuleId:{value:function(e){var n=s.getInfoForObject(e);return this._require.identify(n.moduleId,n.require)}},getObjectLocationId:{value:function(e){var n,t=this.getObjectModuleId(e),o=s.getInfoForObject(e),i=o.objectName;return n=a.MontageSerializer.getDefaultObjectNameForModuleId(t),n===i?t:t+"["+i+"]"}},setObjectProperties:{value:function(e,n){var s,a;a=this.builder.top.getProperty("properties"),this.builder.push(a),"function"==typeof n.serializeProperties?(s=(new t).initWithMalkerAndVisitorAndObject(e,this,n),n.serializeProperties(s)):this.setSerializableObjectProperties(e,n),this.builder.pop()}},setSerializableObjectProperties:{value:function(e,n){for(var a,t,o=s.getSerializablePropertyNames(n),i=o.length,r=0;i>r;r++)t=o[r],a=s.getPropertyAttribute(n,t,"serializable"),this.setProperty(e,t,n[t],a)}},hackIsReferenceAllowedForValue:{value:function(e){return"object"==typeof e&&null!=e&&!("undefined"!=typeof Element&&Element.isElement(e))}},setProperty:{value:function(e,n,s,a){var t;if("reference"===a&&this.hackIsReferenceAllowedForValue(s)){t=this.labeler.getObjectLabel(s);var o=this.builder.createObjectReference(t);this.builder.top.setProperty(n,o)}else e.visit(s,n)}},setObjectCustomUnits:{value:function(e,n){for(var s in this._units)this.setObjectCustomUnit(e,n,s)}},setObjectCustomUnit:{value:function(e,n,s){var a,t,o=this._units[s];o&&(t=(new i).initWithMalkerAndVisitorAndObject(e,this,n),a=o(t,n),null!=a&&e.visit(a,s))}},getExternalObjects:{value:function(){for(var e,n={},s=this.builder.getExternalReferences(),a=0;e=s[a];a++)n[e]=this.labeler.getObjectByLabel(e);return n}},getExternalElements:{value:function(){return this._elements}}});n.MontageVisitor=l}});