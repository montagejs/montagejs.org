montageDefine("07f5592","test/simple/test-stream2-transform",{dependencies:["assert","../common.js","../../lib/_stream_passthrough","../../lib/_stream_transform"],factory:function(e){function t(e,t){s++,o.push([e,t])}function n(){var e=o.shift();if(!e)return console.error("ok");var t=e[0],i=e[1];console.log("# %s",t),i({same:r.deepEqual,equal:r.equal,ok:r,end:function(){s--,n()}})}var r=e("assert");e("../common.js");var i=e("../../lib/_stream_passthrough"),a=e("../../lib/_stream_transform"),o=[],s=0;process.on("exit",function(){r.equal(s,0)}),process.nextTick(n),t("writable side consumption",function(e){var t=new a({highWaterMark:10}),n=0;t._transform=function(e,r,i){n+=e.length,t.push(e),i()};for(var r=1;10>=r;r++)t.write(new Buffer(r));t.end(),e.equal(t._readableState.length,10),e.equal(n,10),e.equal(t._transformState.writechunk.length,5),e.same(t._writableState.buffer.map(function(e){return e.chunk.length}),[6,7,8,9,10]),e.end()}),t("passthrough",function(e){var t=new i;t.write(new Buffer("foog")),t.write(new Buffer("bark")),t.write(new Buffer("bazy")),t.write(new Buffer("kuel")),t.end(),e.equal(""+t.read(5),"foogb"),e.equal(""+t.read(5),"arkba"),e.equal(""+t.read(5),"zykue"),e.equal(""+t.read(5),"l"),e.end()}),t("simple transform",function(e){var t=new a;t._transform=function(e,n,r){var i=new Buffer(e.length);i.fill("x"),t.push(i),r()},t.write(new Buffer("foog")),t.write(new Buffer("bark")),t.write(new Buffer("bazy")),t.write(new Buffer("kuel")),t.end(),e.equal(""+t.read(5),"xxxxx"),e.equal(""+t.read(5),"xxxxx"),e.equal(""+t.read(5),"xxxxx"),e.equal(""+t.read(5),"x"),e.end()}),t("async passthrough",function(e){var t=new a;t._transform=function(e,n,r){setTimeout(function(){t.push(e),r()},10)},t.write(new Buffer("foog")),t.write(new Buffer("bark")),t.write(new Buffer("bazy")),t.write(new Buffer("kuel")),t.end(),t.on("finish",function(){e.equal(""+t.read(5),"foogb"),e.equal(""+t.read(5),"arkba"),e.equal(""+t.read(5),"zykue"),e.equal(""+t.read(5),"l"),e.end()})}),t("assymetric transform (expand)",function(e){var t=new a;t._transform=function(e,n,r){setTimeout(function(){t.push(e),setTimeout(function(){t.push(e),r()},10)},10)},t.write(new Buffer("foog")),t.write(new Buffer("bark")),t.write(new Buffer("bazy")),t.write(new Buffer("kuel")),t.end(),t.on("finish",function(){e.equal(""+t.read(5),"foogf"),e.equal(""+t.read(5),"oogba"),e.equal(""+t.read(5),"rkbar"),e.equal(""+t.read(5),"kbazy"),e.equal(""+t.read(5),"bazyk"),e.equal(""+t.read(5),"uelku"),e.equal(""+t.read(5),"el"),e.end()})}),t("assymetric transform (compress)",function(e){var t=new a;t.state="",t._transform=function(e,n,r){e||(e="");var i=""+e;setTimeout(function(){this.state+=i.charAt(0),3===this.state.length&&(t.push(new Buffer(this.state)),this.state=""),r()}.bind(this),10)},t._flush=function(e){t.push(new Buffer(this.state)),this.state="",e()},t.write(new Buffer("aaaa")),t.write(new Buffer("bbbb")),t.write(new Buffer("cccc")),t.write(new Buffer("dddd")),t.write(new Buffer("eeee")),t.write(new Buffer("aaaa")),t.write(new Buffer("bbbb")),t.write(new Buffer("cccc")),t.write(new Buffer("dddd")),t.write(new Buffer("eeee")),t.write(new Buffer("aaaa")),t.write(new Buffer("bbbb")),t.write(new Buffer("cccc")),t.write(new Buffer("dddd")),t.end(),t.on("finish",function(){e.equal(""+t.read(5),"abcde"),e.equal(""+t.read(5),"abcde"),e.equal(""+t.read(5),"abcd"),e.end()})}),t("passthrough event emission",function(e){var t=new i,n=0;t.on("readable",function(){t._readableState,console.error(">>> emit readable %d",n),n++}),t.write(new Buffer("foog")),console.error("need emit 0"),t.write(new Buffer("bark")),console.error("should have emitted readable now 1 === %d",n),e.equal(n,1),e.equal(""+t.read(5),"foogb"),e.equal(t.read(5)+"","null"),console.error("need emit 1"),t.write(new Buffer("bazy")),console.error("should have emitted, but not again"),t.write(new Buffer("kuel")),console.error("should have emitted readable now 2 === %d",n),e.equal(n,2),e.equal(""+t.read(5),"arkba"),e.equal(""+t.read(5),"zykue"),e.equal(t.read(5),null),console.error("need emit 2"),t.end(),e.equal(n,3),e.equal(""+t.read(5),"l"),e.equal(t.read(5),null),console.error("should not have emitted again"),e.equal(n,3),e.end()}),t("passthrough event emission reordered",function(e){var t=new i,n=0;t.on("readable",function(){console.error("emit readable",n),n++}),t.write(new Buffer("foog")),console.error("need emit 0"),t.write(new Buffer("bark")),console.error("should have emitted readable now 1 === %d",n),e.equal(n,1),e.equal(""+t.read(5),"foogb"),e.equal(t.read(5),null),console.error("need emit 1"),t.once("readable",function(){e.equal(""+t.read(5),"arkba"),e.equal(t.read(5),null),console.error("need emit 2"),t.once("readable",function(){e.equal(""+t.read(5),"zykue"),e.equal(t.read(5),null),t.once("readable",function(){e.equal(""+t.read(5),"l"),e.equal(t.read(5),null),e.equal(n,4),e.end()}),t.end()}),t.write(new Buffer("kuel"))}),t.write(new Buffer("bazy"))}),t("passthrough facaded",function(e){console.error("passthrough facaded");var t=new i,n=[];t.on("data",function(e){n.push(""+e)}),t.on("end",function(){e.same(n,["foog","bark","bazy","kuel"]),e.end()}),t.write(new Buffer("foog")),setTimeout(function(){t.write(new Buffer("bark")),setTimeout(function(){t.write(new Buffer("bazy")),setTimeout(function(){t.write(new Buffer("kuel")),setTimeout(function(){t.end()},10)},10)},10)},10)}),t("object transform (json parse)",function(e){console.error("json parse stream");var t=new a({objectMode:!0});t._transform=function(e,n,r){try{t.push(JSON.parse(e)),r()}catch(i){r(i)}};var n=[{foo:"bar"},100,"string",{nested:{things:[{foo:"bar"},100,"string"]}}],r=!1;t.on("end",function(){r=!0}),n.forEach(function(n){t.write(JSON.stringify(n));var r=t.read();e.same(r,n)}),t.end(),process.nextTick(function(){e.ok(r),e.end()})}),t("object transform (json stringify)",function(e){console.error("json parse stream");var t=new a({objectMode:!0});t._transform=function(e,n,r){try{t.push(JSON.stringify(e)),r()}catch(i){r(i)}};var n=[{foo:"bar"},100,"string",{nested:{things:[{foo:"bar"},100,"string"]}}],r=!1;t.on("end",function(){r=!0}),n.forEach(function(n){t.write(n);var r=t.read();e.equal(r,JSON.stringify(n))}),t.end(),process.nextTick(function(){e.ok(r),e.end()})})}});