var Url=require("url"),Lab=require("lab"),Hawk=require("../lib"),internals={},expect=Lab.expect,before=Lab.before,after=Lab.after,describe=Lab.experiment,it=Lab.test;describe("Hawk",function(){describe("server",function(){var e=function(e,t){var n={id:e,key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:e==="1"?"sha1":"sha256",user:"steve"};return t(null,n)};describe("#authenticate",function(){it("should parse a valid authentication header (sha1)",function(t){var n={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="1", ts="1353788437", nonce="k3j4h2", mac="zy79QQ5/EYFmQqutVnYb73gAc/U=", ext="hello"'};Hawk.server.authenticate(n,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,n,r){expect(e).to.not.exist,expect(n.user).to.equal("steve"),t()})}),it("should parse a valid authentication header (sha256)",function(t){var n={method:"GET",url:"/resource/1?b=1&a=2",host:"example.com",port:8e3,authorization:'Hawk id="dh37fgj492je", ts="1353832234", nonce="j4h3g2", mac="m8r1rHbXN6NgO+KIIhjO7sFRyd78RNGVUwehe8Cp2dU=", ext="some-app-data"'};Hawk.server.authenticate(n,e,{localtimeOffsetMsec:1353832234e3-Hawk.utils.now()},function(e,n,r){expect(e).to.not.exist,expect(n.user).to.equal("steve"),t()})}),it("should parse a valid authentication header (POST with payload)",function(t){var n={method:"POST",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123456", ts="1357926341", nonce="1AwuJD", hash="qAiXIVv+yjDATneWxZP2YCTa9aHRgQdnH9b3Wc+o3dg=", ext="some-app-data", mac="UeYcj5UoTVaAWXNvJfLVia7kU3VabxCqrccXP8sUGC4="'};Hawk.server.authenticate(n,e,{localtimeOffsetMsec:1357926341e3-Hawk.utils.now()},function(e,n,r){expect(e).to.not.exist,expect(n.user).to.equal("steve"),t()})}),it("should fail on missing hash",function(t){var n={method:"GET",url:"/resource/1?b=1&a=2",host:"example.com",port:8e3,authorization:'Hawk id="dh37fgj492je", ts="1353832234", nonce="j4h3g2", mac="m8r1rHbXN6NgO+KIIhjO7sFRyd78RNGVUwehe8Cp2dU=", ext="some-app-data"'};Hawk.server.authenticate(n,e,{payload:"body",localtimeOffsetMsec:1353832234e3-Hawk.utils.now()},function(e,n,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Missing required payload hash"),t()})}),it("should fail on a stale timestamp",function(t){var n={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123456", ts="1362337299", nonce="UzmxSs", ext="some-app-data", mac="wnNUxchvvryMH2RxckTdZ/gY3ijzvccx4keVvELC61w="'};Hawk.server.authenticate(n,e,{},function(e,n,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Stale timestamp");var i=e.response.headers["WWW-Authenticate"],s=i.match(/^Hawk ts\=\"(\d+)\"\, tsm\=\"([^\"]+)\"\, error=\"Stale timestamp\"$/),o=Hawk.utils.now();expect(parseInt(s[1],10)*1e3).to.be.within(o-1e3,o+1e3);var u={headers:{"www-authenticate":i}};expect(Hawk.client.authenticate(u,n,r)).to.equal(!0),t()})}),it("should fail on a replay",function(t){var n={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="bXx7a7p1h9QYQNZ8x7QhvDQym8ACgab4m3lVSFn4DBw=", ext="hello"'},r={},i={localtimeOffsetMsec:1353788437e3-Hawk.utils.now(),nonceFunc:function(e,t,n){return r[e]?n(new Error):(r[e]=!0,n())}};Hawk.server.authenticate(n,e,i,function(r,s,o){expect(r).to.not.exist,expect(s.user).to.equal("steve"),Hawk.server.authenticate(n,e,i,function(e,n,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid nonce"),t()})})}),it("should fail on an invalid authentication header: wrong scheme",function(t){var n={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:"Basic asdasdasdasd"};Hawk.server.authenticate(n,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,n,r){expect(e).to.exist,expect(e.response.payload.message).to.not.exist,t()})}),it("should fail on an invalid authentication header: no scheme",function(t){var n={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:"!@#"};Hawk.server.authenticate(n,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,n,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid header syntax"),t()})}),it("should fail on an missing authorization header",function(t){var n={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};Hawk.server.authenticate(n,e,{},function(e,n,r){expect(e).to.exist,expect(e.isMissing).to.equal(!0),t()})}),it("should fail on an missing host header",function(t){var n={method:"GET",url:"/resource/4?filter=a",headers:{authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'}};Hawk.server.authenticate(n,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,n,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid Host header"),t()})}),it("should fail on an missing authorization attribute (id)",function(t){var n={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(n,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,n,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Missing attributes"),t()})}),it("should fail on an missing authorization attribute (ts)",function(t){var n={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(n,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,n,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Missing attributes"),t()})}),it("should fail on an missing authorization attribute (nonce)",function(t){var n={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(n,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,n,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Missing attributes"),t()})}),it("should fail on an missing authorization attribute (mac)",function(t){var n={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", ext="hello"'};Hawk.server.authenticate(n,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,n,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Missing attributes"),t()})}),it("should fail on an unknown authorization attribute",function(t){var n={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", x="3", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(n,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,n,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Unknown attribute: x"),t()})}),it("should fail on an bad authorization header format",function(t){var n={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123\\", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(n,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,n,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Bad header format"),t()})}),it("should fail on an bad authorization attribute value",function(t){var n={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="	", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(n,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,n,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Bad attribute value: id"),t()})}),it("should fail on an empty authorization attribute value",function(t){var n={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(n,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,n,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Bad attribute value: id"),t()})}),it("should fail on duplicated authorization attribute key",function(t){var n={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", id="456", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(n,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,n,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Duplicate attribute: id"),t()})}),it("should fail on an invalid authorization header format",function(t){var n={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:"Hawk"};Hawk.server.authenticate(n,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,n,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid header syntax"),t()})}),it("should fail on an bad host header (missing host)",function(t){var n={method:"GET",url:"/resource/4?filter=a",headers:{host:":8080",authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'}};Hawk.server.authenticate(n,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,n,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid Host header"),t()})}),it("should fail on an bad host header (pad port)",function(t){var n={method:"GET",url:"/resource/4?filter=a",headers:{host:"example.com:something",authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'}};Hawk.server.authenticate(n,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,n,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid Host header"),t()})}),it("should fail on credentialsFunc error",function(e){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'},n=function(e,t){return t(new Error("Unknown user"))};Hawk.server.authenticate(t,n,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(t,n,r){expect(t).to.exist,expect(t.message).to.equal("Unknown user"),e()})}),it("should fail on missing credentials",function(e){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'},n=function(e,t){return t(null,null)};Hawk.server.authenticate(t,n,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(t,n,r){expect(t).to.exist,expect(t.response.payload.message).to.equal("Unknown credentials"),e()})}),it("should fail on invalid credentials",function(e){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'},n=function(e,t){var n={key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",user:"steve"};return t(null,n)};Hawk.server.authenticate(t,n,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(t,n,r){expect(t).to.exist,expect(t.message).to.equal("Invalid credentials"),expect(t.response.payload.message).to.equal("An internal server error occurred"),e()})}),it("should fail on unknown credentials algorithm",function(e){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'},n=function(e,t){var n={key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"hmac-sha-0",user:"steve"};return t(null,n)};Hawk.server.authenticate(t,n,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(t,n,r){expect(t).to.exist,expect(t.message).to.equal("Unknown algorithm"),expect(t.response.payload.message).to.equal("An internal server error occurred"),e()})}),it("should fail on unknown bad mac",function(e){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcU4jlr7T/wuKe3dKijvTvSos=", ext="hello"'},n=function(e,t){var n={key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"sha256",user:"steve"};return t(null,n)};Hawk.server.authenticate(t,n,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(t,n,r){expect(t).to.exist,expect(t.response.payload.message).to.equal("Bad mac"),e()})})}),describe("#header",function(){it("should return an empty authorization header on missing options",function(e){var t=Hawk.server.header();expect(t).to.equal(""),e()}),it("should return an empty authorization header on missing credentials",function(e){var t=Hawk.server.header(null,{});expect(t).to.equal(""),e()}),it("should return an empty authorization header on invalid credentials",function(e){var t={key:"2983d45yun89q"},n=Hawk.server.header(t);expect(n).to.equal(""),e()}),it("should return an empty authorization header on invalid algorithm",function(e){var t={id:"123456"},n={key:"2983d45yun89q",algorithm:"hmac-sha-0"},r=Hawk.server.header(n,t);expect(r).to.equal(""),e()})})})})