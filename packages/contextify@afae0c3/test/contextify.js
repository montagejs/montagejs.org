var Contextify=require("../lib/contextify.js");exports["basic tests"]={"blank context":function(e){var t=Contextify({});e.notEqual(t,null),e.notEqual(t,undefined),e.done()},"basic context":function(e){var t={prop1:"prop1",prop2:"prop2"};Contextify(t),e.equal(t.prop1,"prop1"),e.equal(t.prop2,"prop2"),e.done()},"basic createContext":function(e){var t={prop1:"prop1",prop2:"prop2"},n=Contextify.createContext(t);e.equal(t.prop1,"prop1"),e.equal(t.prop2,"prop2"),e.done()},"test contextified object extra properties":function(e){var t=Contextify({});e.notEqual(t.run,undefined),e.notEqual(t.getGlobal,undefined),e.notEqual(t.dispose,undefined),e.done()},"createContext should not modify the sandbox":function(e){var t={};Contextify.createContext(t),e.equal(t.run,undefined),e.equal(t.getGlobal,undefined),e.equal(t.dispose,undefined),e.done()},"test undefined sandbox":function(e){e.notEqual(Contextify(undefined,undefined),undefined),e.notEqual(Contextify(),undefined),e.done()},"sandbox prototype properties should be searched":function(e){var t={};t.__proto__={prop1:"test"},Contextify(t),e.equal(t.getGlobal().prop1,"test"),e.done()},"test for nonexistent properties":function(e){var t=Contextify({}).getGlobal();e.equal(t.test1,undefined),e.done()},'test for "undefined" properties':function(e){var t={x:undefined};Contextify(t),t.run("_x = x"),e.equal(t._x,undefined),e.done()},'test for "undefined" properties with createContext':function(e){var t={x:undefined},n=Contextify.createContext(t);n.run("_x = x"),e.equal(t._x,undefined),e.done()},'test for "undefined" variables':function(e){var t={};Contextify(t),t.run("var y; (function() { var _y ; y = _y })()"),e.equal(t._y,undefined),t.run("var z; _z = z"),e.equal(t._z,undefined),e.equal(t.getGlobal().z,undefined),e.done()},"test run with filename":function(e){var t=Contextify();t.run("var x = 3","test.js"),e.equal(t.x,3),e.done()},"test run with createContext":function(e){var t={},n=Contextify.createContext(t);n.run("var x = 3","test.js"),e.equal(t.x,3),e.done()},"test accessors on sandbox":function(e){var t={};t.__defineGetter__("test",function(){return 3}),t.__defineSetter__("test2",function(e){this.x=e}),Contextify(t);var n=t.getGlobal();e.equal(n.test,3),t.test2=5,e.equal(t.x,5),n.test2=7,e.equal(n.x,7),e.equal(t.x,7),e.done()},"test dispose":function(e){var t=Contextify();e.notEqual(t.run,undefined),e.notEqual(t.getGlobal,undefined),e.notEqual(t.dispose,undefined),t.dispose(),e.throws(function(){t.run()},Error),e.throws(function(){t.getGlobal()},Error),e.throws(function(){t.dispose()},Error),e.done()}},exports["synchronous script tests"]={"global variables in scripts should go on sandbox":function(e){var t={prop1:"prop1",prop2:"prop2"};Contextify(t),t.run("x = 3"),e.equal(t.x,3),e.done()},"sandbox properties should be globals":function(e){var t={prop1:"prop1",prop2:"prop2"};Contextify(t),t.run("test1 = (prop1 == 'prop1');test2 = (prop2 == 'prop2');"),e.ok(t.test1),e.ok(t.test2),e.done()}},exports["asynchronous script tests"]={"global variables in scripts should go on sandbox":function(e){var t={setTimeout:setTimeout,prop1:"prop1",prop2:"prop2"};Contextify(t),t.run("setTimeout(function () {x = 3}, 0);"),e.equal(t.x,undefined),setTimeout(function(){e.equal(t.x,3),e.done()},0)},"sandbox properties should be globals":function(e){var t={setTimeout:setTimeout,prop1:"prop1",prop2:"prop2"};Contextify(t),t.run("setTimeout(function () {test1 = (prop1 == 'prop1');test2 = (prop2 == 'prop2');}, 0)"),e.equal(t.test1,undefined),e.equal(t.test2,undefined),setTimeout(function(){e.ok(t.test1),e.ok(t.test2),e.done()},0)},"createContext: sandbox properties should be globals":function(e){var t={setTimeout:setTimeout,prop1:"prop1",prop2:"prop2"},n=Contextify.createContext(t);n.run("setTimeout(function () {test1 = (prop1 == 'prop1');test2 = (prop2 == 'prop2');}, 0)"),e.equal(t.test1,undefined),e.equal(t.test2,undefined),setTimeout(function(){e.ok(t.test1),e.ok(t.test2),e.done()},0)}},exports["test global"]={"basic test":function(e){var t={prop1:"prop1",prop2:"prop2"};Contextify(t);var n=t.getGlobal();e.notDeepEqual(n,null),e.notDeepEqual(n,undefined),e.equal(n.prop1,"prop1"),e.equal(n.prop2,"prop2"),n.prop3="prop3",e.equal(t.prop3,"prop3"),e.done()},"self references to the global object":function(e){var t=Contextify({}),n=t.getGlobal();t.ref1=n,t.ref2={ref2:n},t.run("test1 = (this == ref1);test2 = (this == ref2.ref2);"),e.ok(t.test1),e.ok(t.test2),e.done()},"test enumerator":function(e){var t={prop1:"prop1",prop2:"prop2"},n=Contextify(t).getGlobal(),r=Object.keys(n);e.equal(r.length,5),e.ok(r.indexOf("prop1")!=-1),e.ok(r.indexOf("prop2")!=-1),e.ok(r.indexOf("run")!=-1),e.ok(r.indexOf("getGlobal")!=-1),e.ok(r.indexOf("dispose")!=-1),e.done()},"test deleter":function(e){var t={prop1:"prop1",prop2:"prop2"},n=Contextify(t).getGlobal();e.equal(Object.keys(n).length,5),e.equal(Object.keys(t).length,5),delete n.prop1,e.equal(Object.keys(n).length,4),e.equal(Object.keys(t).length,4),delete n.prop2,e.equal(Object.keys(n).length,3),e.equal(Object.keys(t).length,3),delete n.run,e.equal(Object.keys(n).length,2),e.equal(Object.keys(t).length,2),delete n.getGlobal,e.equal(Object.keys(n).length,1),e.equal(Object.keys(t).length,1),delete n.dispose,e.equal(Object.keys(n).length,0),e.equal(Object.keys(t).length,0),e.done()},"test global class name":function(e){function t(){}var n=Contextify(new t),r=n.getGlobal();e.equal(n.constructor.name,"DOMWindow"),e.equal(n.constructor.name,r.constructor.name),n.run("thisName = this.constructor.name"),e.equal(n.thisName,n.constructor.name),e.done()},"test global functions":function(e){var t=Contextify(),n=t.getGlobal();t.run("function testing () {}"),e.notEqual(n.testing,undefined),e.done()},"test global.run()":function(e){var t=Contextify().getGlobal();t.run("x = 5"),e.equal(t.x,5),e.done()},"test global.getGlobal()":function(e){var t=Contextify().getGlobal();e.deepEqual(t,t.getGlobal()),e.done()},"test global.dispose()":function(e){var t=Contextify(),n=t.getGlobal();e.notEqual(n.run,undefined),e.notEqual(n.getGlobal,undefined),e.notEqual(n.dispose,undefined),n.dispose(),e.throws(function(){t.run()},Error),e.throws(function(){t.getGlobal()},Error),e.throws(function(){t.dispose()},Error),e.done()}},exports["test multiple contexts"]=function(e){var t={prop1:"prop1",prop2:"prop2"},n={prop1:"prop1",prop2:"prop2"},r=Contextify(t).getGlobal(),i=Contextify(n).getGlobal();e.equal(r.prop1,"prop1"),e.equal(i.prop1,"prop1"),t.run("test = 3"),n.run("test = 4"),e.equal(t.test,3),e.equal(r.test,3),e.equal(n.test,4),e.equal(i.test,4),e.done()},exports["test console"]=function(e){var t={console:console,prop1:"prop1"};Contextify(t),e.doesNotThrow(function(){t.run("console.log(prop1);")}),e.done()},exports["test eval"]={"basic test":function(e){var t=Contextify();t.run('eval("test1 = 1")'),e.equal(t.test1,1),t.run('(function() { eval("test2 = 2") })()'),e.equal(t.test2,2),e.done()},"this test":function(e){var t=Contextify();t.run('e = eval ; e("test1 = 1")'),e.equal(t.test1,1),t.run('var t = 1 ; (function() { var t = 2; test2 = eval("t") })()'),e.equal(t.test2,2),t.run('t = 1 ; (function() { var t = 2; e = eval; test3 = e("t") })()'),e.equal(t.test3,1),t.run('var t = 1 ; global = this; (function() { var t = 2; e = eval; test4 = global.eval.call(global, "t") })()'),e.equal(t.test4,1),e.done()}},exports["test exceptions"]={"basic test":function(e){var t=Contextify(),n=t.run("ReferenceError"),r=t.run("SyntaxError");e.throws(function(){t.run("doh")},n),e.throws(function(){t.run("x = y")},n),e.throws(function(){t.run("function ( { (( }{);")},r),e.done()},"test double dispose() - sandbox":function(e){var t=Contextify();e.doesNotThrow(function(){t.dispose()}),e.throws(function(){t.dispose()},"Called dispose() twice."),e.done()},"test double dispose - global":function(e){var t=Contextify(),n=t.getGlobal();e.doesNotThrow(function(){n.dispose()}),e.throws(function(){n.dispose()},"Called dispose() twice."),e.done()},"test run() after dispose()":function(e){var t=Contextify();e.doesNotThrow(function(){t.dispose()}),e.throws(function(){t.run("var x = 3")},"Called run() after dispose()."),e.done()},"test getGlobal() after dispose()":function(e){var t=Contextify();e.doesNotThrow(function(){t.dispose()}),e.throws(function(){var e=t.getGlobal()},"Called getGlobal() after dispose()."),e.done()}},exports["test scripts"]={"test createScript()":function(e){var t=Contextify.createScript("var x = 3","test.js");e.equal(typeof t.runInContext,"function"),e.done()},"test createScript() without code":function(e){e.throws(function(){Contextify.createScript()}),e.throws(function(){Contextify.createScript(!0)}),e.throws(function(){Contextify.createScript(null)}),e.throws(function(){Contextify.createScript(1)}),e.done()},"test runInContext":function(e){var t={},n=Contextify.createScript("var x = 3","test.js"),r=Contextify.createContext(t);n.runInContext(r),e.equal(t.x,3),e.done()}}