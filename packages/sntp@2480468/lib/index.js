var Dgram=require("dgram"),Dns=require("dns"),Hoek=require("hoek"),internals={};exports.time=function(e,t){arguments.length!==2&&(t=arguments[0],e={});var n=Hoek.clone(e);n.host=n.host||"pool.ntp.org",n.port=n.port||123,n.resolveReference=n.resolveReference||!1;var r=0,i=0,s=!1,o=function(e,n){r&&(clearTimeout(r),r=0);if(!s)return s=!0,u.removeAllListeners(),u.close(),t(e,n)},u=Dgram.createSocket("udp4");u.once("error",function(e){return o(e)}),u.on("message",function(e,t){var r=Date.now(),s=new internals.NtpMessage(e);if(!s.isValid)return o(new Error("Invalid server response"),s);if(s.originateTimestamp!==i)return o(new Error("Wrong originate timestamp"),s);var u=s.originateTimestamp,a=s.receiveTimestamp,f=s.transmitTimestamp,l=r;s.d=l-u-(f-a),s.t=(a-u+(f-l))/2,s.receivedLocally=r;if(!n.resolveReference||s.stratum!=="secondary")return o(null,s);Dns.reverse(s.referenceId,function(e,t){return e||(s.referenceHost=t[0]),o(null,s)})}),n.timeout&&(r=setTimeout(function(){return r=0,o(new Error("Timeout"))},n.timeout));var a=new Buffer(48);for(var f=0;f<48;f++)a[f]=0;a[0]=35,i=Date.now(),internals.fromMsecs(i,a,40),u.send(a,0,a.length,n.port,n.host,function(e,t){if(e||t!==48)return o(e||new Error("Could not send entire message"))})},internals.NtpMessage=function(e){this.isValid=!1;if(e.length!==48)return;var t=e[0]>>6;switch(t){case 0:this.leapIndicator="no-warning";break;case 1:this.leapIndicator="last-minute-61";break;case 2:this.leapIndicator="last-minute-59";break;case 3:this.leapIndicator="alarm"}var n=(e[0]&56)>>3;this.version=n;var r=e[0]&7;switch(r){case 1:this.mode="symmetric-active";break;case 2:this.mode="symmetric-passive";break;case 3:this.mode="client";break;case 4:this.mode="server";break;case 5:this.mode="broadcast";break;case 0:case 6:case 7:this.mode="reserved"}var i=e[1];i===0?this.stratum="death":i===1?this.stratum="primary":i<=15?this.stratum="secondary":this.stratum="reserved",this.pollInterval=Math.round(Math.pow(2,e[2]))*1e3,this.precision=Math.pow(2,e[3])*1e3;var s=256*(256*(256*e[4]+e[5])+e[6])+e[7];this.rootDelay=1e3*(s/65536),this.rootDispersion=((e[8]<<8)+e[9]+((e[10]<<8)+e[11])/Math.pow(2,16))*1e3,this.referenceId="";switch(this.stratum){case"death":case"primary":this.referenceId=String.fromCharCode(e[12])+String.fromCharCode(e[13])+String.fromCharCode(e[14])+String.fromCharCode(e[15]);break;case"secondary":this.referenceId=""+e[12]+"."+e[13]+"."+e[14]+"."+e[15]}return this.referenceTimestamp=internals.toMsecs(e,16),this.originateTimestamp=internals.toMsecs(e,24),this.receiveTimestamp=internals.toMsecs(e,32),this.transmitTimestamp=internals.toMsecs(e,40),this.version===4&&this.stratum!=="reserved"&&this.mode==="server"&&this.originateTimestamp&&this.receiveTimestamp&&this.transmitTimestamp&&(this.isValid=!0),this},internals.toMsecs=function(e,t){var n=0,r=0;for(var i=0;i<4;++i)n=n*256+e[t+i];for(i=4;i<8;++i)r=r*256+e[t+i];return(n-2208988800+r/Math.pow(2,32))*1e3},internals.fromMsecs=function(e,t,n){var r=Math.floor(e/1e3)+2208988800,i=Math.round(e%1e3/1e3*Math.pow(2,32));t[n+0]=(r&4278190080)>>24,t[n+1]=(r&16711680)>>16,t[n+2]=(r&65280)>>8,t[n+3]=r&255,t[n+4]=(i&4278190080)>>24,t[n+5]=(i&16711680)>>16,t[n+6]=(i&65280)>>8,t[n+7]=i&255},internals.last={offset:0,expires:0,host:"",port:0},exports.offset=function(e,t){arguments.length!==2&&(t=arguments[0],e={});var n=Date.now(),r=e.clockSyncRefresh||864e5;if(internals.last.offset&&internals.last.host===e.host&&internals.last.port===e.port&&n<internals.last.expires){process.nextTick(function(){t(null,internals.last.offset)});return}exports.time(e,function(i,s){return i?t(i,0):(internals.last={offset:Math.round(s.t),expires:n+r,host:e.host,port:e.port},t(null,internals.last.offset))})},internals.now={intervalId:0},exports.start=function(e,t){arguments.length!==2&&(t=arguments[0],e={});if(internals.now.intervalId){process.nextTick(function(){t()});return}exports.offset(e,function(n,r){return internals.now.intervalId=setInterval(function(){exports.offset(e,function(){})},e.clockSyncRefresh||864e5),t()})},exports.stop=function(){if(!internals.now.intervalId)return;clearInterval(internals.now.intervalId),internals.now.intervalId=0},exports.isLive=function(){return!!internals.now.intervalId},exports.now=function(){var e=Date.now();return!exports.isLive()||e>=internals.last.expires?e:e+internals.last.offset}